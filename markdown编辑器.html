<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdownç¼–è¾‘å™¨</title>
    <style>
        /* CSSå˜é‡å®šä¹‰ - æµ…è‰²ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰ */
        :root {
            --primary-color: #6366f1;
            --primary-light: #818cf8;
            --bg-color: #f5f5f5;
            --editor-bg: white;
            --editor-text-bg: #fafafa;
            --text-color: #333;
            --text-color-light: #555;
            --toolbar-bg: #f8f9fa;
            --toolbar-border: #dee2e6;
            --toolbar-button-bg: white;
            --toolbar-button-hover: #e9ecef;
            --code-bg: #f1f1f1;
            --border-color: #6366f1;
        }

        /* æ·±è‰²ä¸»é¢˜ */
        body.dark-theme {
            --bg-color: #1a1a1a;
            --editor-bg: #1e1e1e;
            --editor-text-bg: #1e1e1e;
            --text-color: #ffffff;
            --text-color-light: #cccccc;
            --toolbar-bg: #2d2d2d;
            --toolbar-border: #404040;
            --toolbar-button-bg: #3a3a3a;
            --toolbar-button-hover: #4a4a4a;
            --code-bg: #2d2d2d;
            --border-color: #6366f1;
        }

        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* é¡µé¢ä¸»ä½“å®¹å™¨ - ä½¿ç”¨Gridå¸ƒå±€ */
        body {
            font-family: 'Arial', sans-serif;
            height: 100vh;
            display: grid;
            grid-template-rows: auto auto 1fr auto; /* å››è¡Œå¸ƒå±€ï¼šæ ‡é¢˜æ ã€å·¥å…·æ ã€ä¸»åŒºåŸŸã€çŠ¶æ€æ  */
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ æ ·å¼ */
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* ä¸­é—´ä¸»åŒºåŸŸå®¹å™¨ - ä½¿ç”¨Gridåˆ›å»ºåŒæ å¸ƒå±€ */
        .main-container {
            display: grid;
            grid-template-columns: var(--editor-width, 50%) 4px var(--preview-width, calc(100% - var(--editor-width, 50%) - 4px));
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        /* å·¦ä¾§ç¼–è¾‘å™¨åŒºåŸŸ */
        .editor-section {
            display: flex;
            flex-direction: column;
            background-color: var(--editor-bg);
            overflow: hidden;
        }

        /* å¯æ‹–æ‹½çš„åˆ†å‰²æ¡ */
        .resizer {
            width: 4px;
            background-color: var(--border-color);
            cursor: col-resize;
            position: relative;
            user-select: none;
            transition: background-color 0.2s;
        }

        .resizer:hover {
            background-color: var(--primary-light);
        }

        .resizer::before {
            content: '';
            position: absolute;
            left: -2px;
            right: -2px;
            top: 0;
            bottom: 0;
        }

        /* ç¼–è¾‘å™¨æ ‡é¢˜ */
        .editor-title {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
        }

        /* textareaç¼–è¾‘å™¨æ ·å¼ */
        .editor {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            width: 100%;
            padding: 15px;
            border: none;
            outline: none;
            resize: none; /* ç¦ç”¨æ‹–æ‹½è°ƒæ•´å¤§å° */
            font-family: 'Monaco', 'Consolas', monospace; /* ç­‰å®½å­—ä½“ */
            font-size: 14px;
            line-height: 1.6;
            background-color: var(--editor-text-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* å³ä¾§é¢„è§ˆåŒºåŸŸ */
        .preview-section {
            display: flex;
            flex-direction: column;
            background-color: var(--editor-bg);
            overflow: hidden;
        }

        /* é¢„è§ˆåŒºæ ‡é¢˜ */
        .preview-title {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
        }

        /* é¢„è§ˆå†…å®¹åŒºåŸŸ */
        .preview {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            padding: 15px;
            overflow-y: auto; /* å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            font-family: 'Arial', sans-serif; /* æ­£å¸¸å­—ä½“ */
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
            word-wrap: break-word; /* é•¿å•è¯è‡ªåŠ¨æ¢è¡Œ */
            transition: background-color 0.3s, color 0.3s;
        }

        /* é¢„è§ˆåŒºåŸŸä¸­çš„æ ‡é¢˜æ ·å¼ */
        .preview h1 {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0 10px 0;
        }

        .preview h2 {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-light);
            margin: 12px 0 8px 0;
        }

        .preview h3 {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 12px 0 8px 0;
        }

        .preview h4 {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0 6px 0;
        }

        .preview h5 {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0 6px 0;
        }

        .preview h6 {
            font-size: 13px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0 6px 0;
        }

        /* ä»£ç æ ·å¼ */
        .preview code {
            background-color: var(--code-bg);
            font-family: 'Monaco', 'Consolas', monospace;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }

        /* ä»£ç å—æ ·å¼ */
        .preview pre {
            background-color: var(--code-bg);
            padding: 12px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            border-left: 3px solid var(--primary-color);
        }

        .preview pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            font-size: 13px;
            display: block;
        }

        /* å¼•ç”¨å—æ ·å¼ */
        .preview blockquote {
            border-left: 5px solid var(--primary-color);
            padding-left: 10px;
            margin: 10px 0;
            color: var(--text-color-light);
            font-style: italic;
        }

        /* åˆ—è¡¨æ ·å¼ */
        .preview ul {
            margin: 10px 0;
            padding-left: 25px;
        }

        .preview ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .preview li {
            margin: 5px 0;
        }

        /* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
        .preview .task-list {
            list-style: none;
            padding-left: 0;
        }

        .preview .task-item {
            display: flex;
            align-items: flex-start;
            margin: 5px 0;
            padding-left: 0;
        }

        .preview .task-item input[type="checkbox"] {
            margin-right: 8px;
            margin-top: 3px;
            cursor: default;
        }

        /* åˆ é™¤çº¿æ ·å¼ */
        .preview del {
            text-decoration: line-through;
            color: var(--text-color-light);
        }

        /* è¡¨æ ¼æ ·å¼ */
        .preview table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            border: 1px solid var(--toolbar-border);
        }

        .preview table th,
        .preview table td {
            border: 1px solid var(--toolbar-border);
            padding: 8px 12px;
            text-align: left;
        }

        .preview table th {
            background-color: var(--toolbar-bg);
            font-weight: bold;
            color: var(--primary-color);
        }

        .preview table tr:nth-child(even) {
            background-color: var(--editor-text-bg);
        }

        .preview table tr:hover {
            background-color: var(--toolbar-button-hover);
        }

        /* é“¾æ¥æ ·å¼ */
        .preview a {
            color: var(--primary-color);
            text-decoration: none;
            border-bottom: 1px solid var(--primary-color);
        }

        .preview a:hover {
            color: var(--primary-light);
            border-bottom-color: var(--primary-light);
        }

        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            background-color: var(--toolbar-bg);
            padding: 10px 15px;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between; /* å·¦å³åˆ†å¸ƒ */
            border-bottom: 1px solid var(--toolbar-border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* å·¥å…·æ å·¦ä¾§æŒ‰é’®ç»„ */
        .toolbar-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* å·¥å…·æ å³ä¾§æ–‡ä»¶æ“ä½œæŒ‰é’®ç»„ */
        .toolbar-right {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto; /* æ¨åˆ°å³ä¾§ */
        }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† */
        #fileInput {
            display: none;
        }

        /* å·¥å…·æ æŒ‰é’®æ ·å¼ */
        .toolbar button {
            background-color: var(--toolbar-button-bg);
            border: 1px solid var(--toolbar-border);
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }

        /* å·¥å…·æ æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .toolbar button:hover {
            background-color: var(--toolbar-button-hover);
        }

        /* å·¥å…·æ æŒ‰é’®æ¿€æ´»çŠ¶æ€ */
        .toolbar button:active {
            background-color: #dee2e6;
        }

        /* å·¥å…·æ æŒ‰é’®ä¸­çš„ç²—ä½“å’Œæ–œä½“æ ‡ç­¾æ ·å¼ */
        .toolbar button b {
            font-weight: bold;
        }

        .toolbar button i {
            font-style: italic;
        }

        .toolbar button s {
            text-decoration: line-through;
        }

        /* åº•éƒ¨çŠ¶æ€æ æ ·å¼ */
        .status-bar {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr !important;
                grid-template-rows: 1fr 1fr;
            }

            .resizer {
                display: none;
            }

            .toolbar {
                flex-wrap: wrap;
                padding: 8px 10px;
            }

            .toolbar-left {
                flex-wrap: wrap;
            }

            .toolbar button {
                min-width: 32px;
                height: 32px;
                padding: 6px 8px;
                font-size: 12px;
            }

            .header {
                padding: 15px;
                font-size: 20px;
            }

            .status-bar {
                flex-direction: column;
                gap: 5px;
                padding: 8px 15px;
                font-size: 12px;
            }

            .status-left,
            .status-right {
                flex-direction: column;
                gap: 5px;
            }
        }

        /* çŠ¶æ€æ å·¦ä¾§ä¿¡æ¯ */
        .status-left {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        /* çŠ¶æ€æ å³ä¾§ä¿¡æ¯ */
        .status-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        /* çŠ¶æ€é¡¹æ ·å¼ */
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <header class="header">
        Markdownç¼–è¾‘å™¨
    </header>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <button data-action="bold" title="åŠ ç²—"><b>B</b></button>
            <button data-action="italic" title="æ–œä½“"><i>I</i></button>
            <button data-action="strikethrough" title="åˆ é™¤çº¿"><s>S</s></button>
            <button data-action="h1" title="ä¸€çº§æ ‡é¢˜">H1</button>
            <button data-action="h2" title="äºŒçº§æ ‡é¢˜">H2</button>
            <button data-action="h3" title="ä¸‰çº§æ ‡é¢˜">H3</button>
            <button data-action="h4" title="å››çº§æ ‡é¢˜">H4</button>
            <button data-action="h5" title="äº”çº§æ ‡é¢˜">H5</button>
            <button data-action="h6" title="å…­çº§æ ‡é¢˜">H6</button>
            <button data-action="ulist" title="æ— åºåˆ—è¡¨">â€¢</button>
            <button data-action="olist" title="æœ‰åºåˆ—è¡¨">1.</button>
            <button data-action="tasklist" title="ä»»åŠ¡åˆ—è¡¨">â˜‘ï¸</button>
            <button data-action="quote" title="å¼•ç”¨">â</button>
            <button data-action="code" title="ä»£ç å—"><> </button>
            <button data-action="link" title="é“¾æ¥">ğŸ”—</button>
            <button data-action="table" title="è¡¨æ ¼">ğŸ“Š</button>
        </div>
        <div class="toolbar-right">
            <button data-action="theme" title="åˆ‡æ¢ä¸»é¢˜" id="themeBtn">ğŸŒ™</button>
            <button data-action="new" title="æ–°å»º">ğŸ“„</button>
            <button data-action="open" title="æ‰“å¼€">ğŸ“‚</button>
            <button data-action="save" title="ä¿å­˜">ğŸ’¾</button>
            <button data-action="autosave" title="è‡ªåŠ¨ä¿å­˜" id="autosaveBtn">ğŸ”“</button>
        </div>
        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
        <input type="file" id="fileInput" accept=".md,.txt">
    </div>

    <!-- ä¸­é—´ä¸»åŒºåŸŸï¼šåŒæ å¸ƒå±€ -->
    <div class="main-container">
        <!-- å·¦ä¾§ç¼–è¾‘å™¨åŒºåŸŸ -->
        <div class="editor-section">
            <div class="editor-title">ç¼–è¾‘å™¨</div>
            <textarea 
                id="editor" 
                class="editor" 
                placeholder="åœ¨æ­¤è¾“å…¥Markdownæ–‡æœ¬..."
            ></textarea>
        </div>

        <!-- å¯æ‹–æ‹½çš„åˆ†å‰²æ¡ -->
        <div class="resizer" id="resizer"></div>

        <!-- å³ä¾§é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-section">
            <div class="preview-title">é¢„è§ˆ</div>
            <div id="preview" class="preview"></div>
        </div>
    </div>

    <!-- åº•éƒ¨çŠ¶æ€æ  -->
    <footer class="status-bar">
        <div class="status-left">
            <div class="status-item">
                <span>å­—æ•°ï¼š</span>
                <span id="wordCount">0</span>
            </div>
            <div class="status-item">
                <span id="saveStatus">å·²ä¿å­˜</span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-item">
                <span id="autosaveStatus">è‡ªåŠ¨ä¿å­˜ï¼šå¼€å¯</span>
            </div>
        </div>
    </footer>

    <script>
        // è·å–DOMå…ƒç´ 
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const fileInput = document.getElementById('fileInput');
        const autosaveBtn = document.getElementById('autosaveBtn');
        const themeBtn = document.getElementById('themeBtn');
        const wordCountEl = document.getElementById('wordCount');
        const saveStatusEl = document.getElementById('saveStatus');
        const autosaveStatusEl = document.getElementById('autosaveStatus');
        const resizer = document.getElementById('resizer');
        const mainContainer = document.querySelector('.main-container');

        // æ–‡ä»¶æ“ä½œç›¸å…³å˜é‡
        let autosaveEnabled = true; // é»˜è®¤å¼€å¯è‡ªåŠ¨ä¿å­˜
        let autosaveTimer = null; // è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
        let lastSavedContent = ''; // ä¸Šæ¬¡ä¿å­˜çš„å†…å®¹
        const STORAGE_KEY = 'markdown_editor_content'; // localStorageé”®å
        const STORAGE_KEY_THEME = 'markdown_editor_theme'; // ä¸»é¢˜åå¥½é”®å
        const STORAGE_KEY_WIDTH = 'markdown_editor_width'; // å®½åº¦åå¥½é”®å

        // é˜²æŠ–å‡½æ•°
        let debounceTimer = null;
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        /**
         * XSSé˜²æŠ¤ï¼šè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
         * @param {string} text - éœ€è¦è½¬ä¹‰çš„æ–‡æœ¬
         * @returns {string} è½¬ä¹‰åçš„æ–‡æœ¬
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Markdownè§£æå‡½æ•°
         * å°†Markdownè¯­æ³•è½¬æ¢ä¸ºHTML
         * @param {string} text - åŸå§‹Markdownæ–‡æœ¬
         * @returns {string} è§£æåçš„HTMLå­—ç¬¦ä¸²
         */
        function parseMarkdown(text) {
            if (!text) return '';

            let html = text;

            // ç¬¬ä¸€æ­¥ï¼šè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼ˆXSSé˜²æŠ¤ï¼‰
            html = escapeHtml(html);

            // ç¬¬äºŒæ­¥ï¼šå…ˆæå–ä»£ç å—ï¼ˆ```ä»£ç å—```ï¼‰ï¼Œé¿å…ä»£ç å—å†…å®¹è¢«è¯¯è§£æ
            const codeBlockPlaceholder = '___CODE_BLOCK_PLACEHOLDER___';
            const codeBlocks = [];
            let codeBlockIndex = 0;
            
            // åŒ¹é…ä»£ç å—ï¼š```è¯­è¨€\nä»£ç å†…å®¹\n```ï¼ˆæ”¯æŒå¤šè¡Œï¼‰
            html = html.replace(/```(\w*)?\n([\s\S]*?)```/g, function(match, lang, content) {
                const escapedContent = escapeHtml(content);
                const codeBlock = `<pre><code${lang ? ' class="language-' + lang + '"' : ''}>${escapedContent}</code></pre>`;
                codeBlocks.push(codeBlock);
                return codeBlockPlaceholder + (codeBlockIndex++) + codeBlockPlaceholder;
            });

            // ç¬¬ä¸‰æ­¥ï¼šå¤„ç†è¡Œå†…ä»£ç  `ä»£ç `
            const inlineCodePlaceholder = '___INLINE_CODE_PLACEHOLDER___';
            const inlineCodes = [];
            let inlineCodeIndex = 0;
            
            html = html.replace(/`([^`]+)`/g, function(match, content) {
                inlineCodes.push(`<code>${content}</code>`);
                return inlineCodePlaceholder + (inlineCodeIndex++) + inlineCodePlaceholder;
            });

            // ç¬¬å››æ­¥ï¼šæŒ‰è¡Œå¤„ç†å—çº§å…ƒç´ 
            const lines = html.split('\n');
            const processedLines = [];
            let inList = false; // æ ‡è®°æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
            let listType = null; // åˆ—è¡¨ç±»å‹ï¼š'ul'ã€'ol' æˆ– 'task'
            let inTable = false; // æ ‡è®°æ˜¯å¦åœ¨è¡¨æ ¼ä¸­
            let tableRows = []; // å­˜å‚¨è¡¨æ ¼è¡Œ
            let isTableHeader = false; // æ ‡è®°æ˜¯å¦æ˜¯è¡¨å¤´

            // è¾…åŠ©å‡½æ•°ï¼šå…³é—­åˆ—è¡¨
            function closeList() {
                if (inList) {
                    processedLines.push(listType === 'ul' ? '</ul>' : listType === 'ol' ? '</ol>' : '</ul>');
                    inList = false;
                    listType = null;
                }
            }

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                const trimmedLine = line.trim();

                // å¤„ç†ä»£ç å—å ä½ç¬¦ï¼ˆç›´æ¥è¾“å‡ºï¼Œä¸è¿›è¡Œå…¶ä»–å¤„ç†ï¼‰
                if (line.includes(codeBlockPlaceholder)) {
                    // å…³é—­ä¹‹å‰çš„åˆ—è¡¨å’Œè¡¨æ ¼
                    if (inList) {
                        processedLines.push(listType === 'ul' ? '</ul>' : listType === 'ol' ? '</ol>' : '</ul>');
                        inList = false;
                        listType = null;
                    }
                    if (inTable) {
                        processedLines.push('</tbody></table>');
                        inTable = false;
                        tableRows = [];
                    }
                    processedLines.push(line);
                    continue;
                }

                // å¤„ç†è¡¨æ ¼åˆ†éš”è¡Œï¼ˆ|---|---|ï¼‰
                const tableSeparatorMatch = trimmedLine.match(/^\|[\s\-\|:]+\|$/);
                if (tableSeparatorMatch) {
                    if (inTable && tableRows.length > 0) {
                        // è¾“å‡ºè¡¨å¤´
                        processedLines.push('<thead><tr>');
                        tableRows[0].forEach(cell => {
                            processedLines.push(`<th>${cell.trim()}</th>`);
                        });
                        processedLines.push('</tr></thead><tbody>');
                        tableRows = tableRows.slice(1);
                        isTableHeader = false;
                    }
                    continue;
                }

                // å¤„ç†è¡¨æ ¼è¡Œï¼ˆ|åˆ—1|åˆ—2|ï¼‰
                const tableRowMatch = trimmedLine.match(/^\|(.+)\|$/);
                if (tableRowMatch) {
                    const cells = tableRowMatch[1].split('|').map(cell => cell.trim());
                    if (!inTable) {
                        // å…³é—­ä¹‹å‰çš„åˆ—è¡¨
                        if (inList) {
                            processedLines.push(listType === 'ul' ? '</ul>' : listType === 'ol' ? '</ol>' : '</ul>');
                            inList = false;
                            listType = null;
                        }
                        processedLines.push('<table>');
                        inTable = true;
                        isTableHeader = true;
                    }
                    tableRows.push(cells);
                    continue;
                }

                // å¦‚æœä¸æ˜¯è¡¨æ ¼è¡Œï¼Œä½†ä¹‹å‰åœ¨è¡¨æ ¼ä¸­ï¼Œå…³é—­è¡¨æ ¼
                if (inTable && trimmedLine !== '') {
                    // è¾“å‡ºè¡¨æ ¼å†…å®¹
                    if (isTableHeader && tableRows.length > 0) {
                        processedLines.push('<thead><tr>');
                        tableRows[0].forEach(cell => {
                            processedLines.push(`<th>${cell.trim()}</th>`);
                        });
                        processedLines.push('</tr></thead><tbody>');
                        tableRows = tableRows.slice(1);
                    }
                    tableRows.forEach(row => {
                        processedLines.push('<tr>');
                        row.forEach(cell => {
                            processedLines.push(`<td>${cell.trim()}</td>`);
                        });
                        processedLines.push('</tr>');
                    });
                    processedLines.push('</tbody></table>');
                    inTable = false;
                    tableRows = [];
                    isTableHeader = false;
                }

                // å¤„ç†ä¸€çº§æ ‡é¢˜ # æ ‡é¢˜
                if (trimmedLine.match(/^#\s+/)) {
                    closeList();
                    const title = trimmedLine.replace(/^#+\s+/, '');
                    processedLines.push(`<h1>${title}</h1>`);
                    continue;
                }

                // å¤„ç†äºŒçº§æ ‡é¢˜ ## æ ‡é¢˜
                if (trimmedLine.match(/^##\s+/)) {
                    closeList();
                    const title = trimmedLine.replace(/^##+\s+/, '');
                    processedLines.push(`<h2>${title}</h2>`);
                    continue;
                }

                // å¤„ç†ä¸‰çº§æ ‡é¢˜ ### æ ‡é¢˜
                if (trimmedLine.match(/^###\s+/)) {
                    closeList();
                    const title = trimmedLine.replace(/^###+\s+/, '');
                    processedLines.push(`<h3>${title}</h3>`);
                    continue;
                }

                // å¤„ç†å››çº§æ ‡é¢˜ #### æ ‡é¢˜
                if (trimmedLine.match(/^####\s+/)) {
                    closeList();
                    const title = trimmedLine.replace(/^####+\s+/, '');
                    processedLines.push(`<h4>${title}</h4>`);
                    continue;
                }

                // å¤„ç†äº”çº§æ ‡é¢˜ ##### æ ‡é¢˜
                if (trimmedLine.match(/^#####\s+/)) {
                    closeList();
                    const title = trimmedLine.replace(/^#####+\s+/, '');
                    processedLines.push(`<h5>${title}</h5>`);
                    continue;
                }

                // å¤„ç†å…­çº§æ ‡é¢˜ ###### æ ‡é¢˜
                if (trimmedLine.match(/^######\s+/)) {
                    closeList();
                    const title = trimmedLine.replace(/^######+\s+/, '');
                    processedLines.push(`<h6>${title}</h6>`);
                    continue;
                }

                // å¤„ç†å¼•ç”¨ > å¼•ç”¨å†…å®¹
                if (trimmedLine.startsWith('> ')) {
                    closeList();
                    const quote = trimmedLine.substring(2);
                    processedLines.push(`<blockquote>${quote}</blockquote>`);
                    continue;
                }

                // å¤„ç†ä»»åŠ¡åˆ—è¡¨é¡¹ - [x] æˆ– - [ ]
                const taskListMatch = trimmedLine.match(/^-\s+\[([ xX])\]\s+(.+)$/);
                if (taskListMatch) {
                    const isChecked = taskListMatch[1].toLowerCase() === 'x';
                    const taskText = taskListMatch[2];
                    if (!inList || listType !== 'task') {
                        closeList();
                        processedLines.push('<ul class="task-list">');
                        inList = true;
                        listType = 'task';
                    }
                    processedLines.push(`<li class="task-item"><input type="checkbox" ${isChecked ? 'checked' : ''} disabled> ${taskText}</li>`);
                    continue;
                }

                // å¤„ç†æœ‰åºåˆ—è¡¨é¡¹ 1. åˆ—è¡¨é¡¹ã€2. åˆ—è¡¨é¡¹ç­‰
                const orderedListMatch = trimmedLine.match(/^\d+\.\s+(.+)$/);
                if (orderedListMatch) {
                    const listItem = orderedListMatch[1];
                    if (!inList || listType !== 'ol') {
                        closeList();
                        processedLines.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    processedLines.push(`<li>${listItem}</li>`);
                    continue;
                }

                // å¤„ç†æ— åºåˆ—è¡¨é¡¹ - åˆ—è¡¨é¡¹
                if (trimmedLine.startsWith('- ')) {
                    const listItem = trimmedLine.substring(2);
                    if (!inList || listType !== 'ul') {
                        closeList();
                        processedLines.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    processedLines.push(`<li>${listItem}</li>`);
                    continue;
                }

                // å¤„ç†ç©ºè¡Œ
                if (trimmedLine === '') {
                    closeList();
                    processedLines.push('<br>');
                    continue;
                }

                // æ™®é€šæ–‡æœ¬è¡Œ
                closeList();
                processedLines.push(line);
            }

            // å…³é—­æœªå…³é—­çš„åˆ—è¡¨å’Œè¡¨æ ¼
            closeList();
            if (inTable) {
                if (isTableHeader && tableRows.length > 0) {
                    processedLines.push('<thead><tr>');
                    tableRows[0].forEach(cell => {
                        processedLines.push(`<th>${cell.trim()}</th>`);
                    });
                    processedLines.push('</tr></thead><tbody>');
                    tableRows = tableRows.slice(1);
                }
                tableRows.forEach(row => {
                    processedLines.push('<tr>');
                    row.forEach(cell => {
                        processedLines.push(`<td>${cell.trim()}</td>`);
                    });
                    processedLines.push('</tr>');
                });
                processedLines.push('</tbody></table>');
            }

            // åˆå¹¶æ‰€æœ‰è¡Œ
            html = processedLines.join('\n');

            // ç¬¬äº”æ­¥ï¼šå¤„ç†è¡Œå†…æ ¼å¼ï¼ˆåˆ é™¤çº¿ã€ç²—ä½“ã€æ–œä½“ã€é“¾æ¥ï¼‰
            // ä¸ºäº†é¿å…ä»£ç æ ‡ç­¾å†…çš„å†…å®¹è¢«å¤„ç†ï¼Œå…ˆä¸´æ—¶æ›¿æ¢ä»£ç æ ‡ç­¾
            
            // ä¸´æ—¶æ›¿æ¢è¡Œå†…ä»£ç å ä½ç¬¦
            html = html.replace(new RegExp(inlineCodePlaceholder + '(\\d+)' + inlineCodePlaceholder, 'g'), function(match, index) {
                return inlineCodes[parseInt(index)] || match;
            });

            // ä¸´æ—¶æ›¿æ¢ä»£ç å—å ä½ç¬¦
            html = html.replace(new RegExp(codeBlockPlaceholder + '(\\d+)' + codeBlockPlaceholder, 'g'), function(match, index) {
                return codeBlocks[parseInt(index)] || match;
            });

            // å†æ¬¡æå–è¡Œå†…ä»£ç ï¼Œé¿å…è¢«å…¶ä»–æ ¼å¼å¤„ç†
            const finalCodePlaceholder = '___FINAL_CODE_PLACEHOLDER___';
            const finalCodes = [];
            let finalCodeIndex = 0;
            
            html = html.replace(/<code>([^<]+)<\/code>/g, function(match, content) {
                finalCodes.push(match);
                return finalCodePlaceholder + (finalCodeIndex++) + finalCodePlaceholder;
            });

            // å¤„ç†åˆ é™¤çº¿ ~~åˆ é™¤çº¿~~
            html = html.replace(/~~([^~]+)~~/g, '<del>$1</del>');

            // å¤„ç†ç²—ä½“ **ç²—ä½“** æˆ– __ç²—ä½“__
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');

            // å¤„ç†æ–œä½“ *æ–œä½“* æˆ– _æ–œä½“_
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

            // å¤„ç†é“¾æ¥ [æ–‡æœ¬](URL)
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // æ¢å¤è¡Œå†…ä»£ç æ ‡ç­¾
            for (let i = 0; i < finalCodes.length; i++) {
                html = html.replace(finalCodePlaceholder + i + finalCodePlaceholder, finalCodes[i]);
            }

            return html;
        }

        /**
         * æ›´æ–°é¢„è§ˆå†…å®¹ï¼ˆå†…éƒ¨å‡½æ•°ï¼Œä¸ä½¿ç”¨é˜²æŠ–ï¼‰
         * ä½¿ç”¨parseMarkdownå‡½æ•°å¤„ç†æ–‡æœ¬å¹¶æ›´æ–°é¢„è§ˆåŒºåŸŸ
         */
        function updatePreviewInternal() {
            const markdownText = editor.value;
            const html = parseMarkdown(markdownText);
            preview.innerHTML = html;
            // æ›´æ–°å­—æ•°ç»Ÿè®¡
            updateWordCount();
            // æ›´æ–°ä¿å­˜çŠ¶æ€
            updateSaveStatus();
        }

        /**
         * æ›´æ–°é¢„è§ˆå†…å®¹ï¼ˆä½¿ç”¨é˜²æŠ–ä¼˜åŒ–æ€§èƒ½ï¼‰
         */
        const updatePreview = debounce(updatePreviewInternal, 300);

        /**
         * æ›´æ–°å­—æ•°ç»Ÿè®¡
         */
        function updateWordCount() {
            const text = editor.value;
            const count = text.length;
            wordCountEl.textContent = count;
        }

        /**
         * æ›´æ–°ä¿å­˜çŠ¶æ€
         */
        function updateSaveStatus() {
            const currentContent = editor.value;
            if (currentContent === lastSavedContent) {
                saveStatusEl.textContent = 'å·²ä¿å­˜';
                saveStatusEl.style.color = '#fff';
            } else {
                saveStatusEl.textContent = 'æœªä¿å­˜';
                saveStatusEl.style.color = '#ffeb3b';
            }
        }

        /**
         * ä¿å­˜åˆ°localStorage
         */
        function saveToLocalStorage() {
            const content = editor.value;
            localStorage.setItem(STORAGE_KEY, content);
            lastSavedContent = content;
            updateSaveStatus();
        }

        /**
         * ä»localStorageæ¢å¤å†…å®¹
         */
        function loadFromLocalStorage() {
            const savedContent = localStorage.getItem(STORAGE_KEY);
            if (savedContent !== null) {
                editor.value = savedContent;
                lastSavedContent = savedContent;
                updatePreviewInternal();
            }
        }

        /**
         * æ–°å»ºæ–‡ä»¶
         */
        function newFile() {
            if (editor.value && confirm('ç¡®å®šè¦æ–°å»ºæ–‡ä»¶å—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¸¢å¤±ã€‚')) {
                editor.value = '';
                lastSavedContent = '';
                updatePreviewInternal();
                editor.focus();
            } else if (!editor.value) {
                editor.value = '';
                lastSavedContent = '';
                updatePreviewInternal();
                editor.focus();
            }
        }

        /**
         * æ‰“å¼€æ–‡ä»¶
         */
        function openFile() {
            fileInput.click();
        }

        /**
         * å¤„ç†æ–‡ä»¶é€‰æ‹©
         */
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.md') && !fileName.endsWith('.txt')) {
                alert('è¯·é€‰æ‹© .md æˆ– .txt æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                editor.value = content;
                lastSavedContent = content;
                // ç«‹å³ä¿å­˜åˆ°localStorageï¼ˆå¦‚æœè‡ªåŠ¨ä¿å­˜å¼€å¯ï¼‰
                if (autosaveEnabled) {
                    saveToLocalStorage();
                }
                updatePreviewInternal();
                editor.focus();
            };
            reader.readAsText(file);

            // æ¸…ç©ºinputï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
            fileInput.value = '';
        });

        /**
         * ä¿å­˜æ–‡ä»¶
         */
        function saveFile() {
            const content = editor.value;
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const fileName = `markdown-${year}${month}${day}-${hours}${minutes}${seconds}.md`;

            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // æ›´æ–°ä¿å­˜çŠ¶æ€
            lastSavedContent = content;
            updateSaveStatus();
        }

        /**
         * åˆ‡æ¢è‡ªåŠ¨ä¿å­˜
         */
        function toggleAutosave() {
            autosaveEnabled = !autosaveEnabled;
            updateAutosaveUI();
            
            if (autosaveEnabled) {
                startAutosave();
            } else {
                stopAutosave();
            }
        }

        /**
         * æ›´æ–°è‡ªåŠ¨ä¿å­˜UI
         */
        function updateAutosaveUI() {
            if (autosaveEnabled) {
                autosaveBtn.textContent = 'ğŸ”“';
                autosaveBtn.title = 'è‡ªåŠ¨ä¿å­˜ï¼šå¼€å¯';
                autosaveStatusEl.textContent = 'è‡ªåŠ¨ä¿å­˜ï¼šå¼€å¯';
            } else {
                autosaveBtn.textContent = 'ğŸ”’';
                autosaveBtn.title = 'è‡ªåŠ¨ä¿å­˜ï¼šå…³é—­';
                autosaveStatusEl.textContent = 'è‡ªåŠ¨ä¿å­˜ï¼šå…³é—­';
            }
        }

        /**
         * å¯åŠ¨è‡ªåŠ¨ä¿å­˜
         */
        function startAutosave() {
            stopAutosave(); // å…ˆæ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            autosaveTimer = setInterval(function() {
                saveToLocalStorage();
            }, 5000); // æ¯5ç§’ä¿å­˜ä¸€æ¬¡
        }

        /**
         * åœæ­¢è‡ªåŠ¨ä¿å­˜
         */
        function stopAutosave() {
            if (autosaveTimer) {
                clearInterval(autosaveTimer);
                autosaveTimer = null;
            }
        }

        /**
         * åœ¨textareaå…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
         * @param {HTMLTextAreaElement} textarea - textareaå…ƒç´ 
         * @param {string} text - è¦æ’å…¥çš„æ–‡æœ¬
         * @param {number} cursorOffset - æ’å…¥åå…‰æ ‡ä½ç½®çš„åç§»é‡ï¼ˆç›¸å¯¹äºæ’å…¥æ–‡æœ¬çš„æœ«å°¾ï¼‰
         */
        function insertAtCursor(textarea, text, cursorOffset = 0) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const currentText = textarea.value;
            
            // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
            const newText = currentText.substring(0, start) + text + currentText.substring(end);
            textarea.value = newText;
            
            // è®¾ç½®æ–°çš„å…‰æ ‡ä½ç½®
            const newCursorPos = start + text.length + cursorOffset;
            setCursorPosition(textarea, newCursorPos);
            
            // è®©textareaè·å¾—ç„¦ç‚¹
            textarea.focus();
        }

        /**
         * è®¾ç½®textareaçš„å…‰æ ‡ä½ç½®
         * @param {HTMLTextAreaElement} textarea - textareaå…ƒç´ 
         * @param {number} pos - å…‰æ ‡ä½ç½®
         */
        function setCursorPosition(textarea, pos) {
            textarea.selectionStart = pos;
            textarea.selectionEnd = pos;
        }

        /**
         * å¤„ç†å·¥å…·æ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
         * æ ¹æ®æŒ‰é’®çš„data-actionå±æ€§æ’å…¥å¯¹åº”çš„Markdownè¯­æ³•æˆ–æ‰§è¡Œæ–‡ä»¶æ“ä½œ
         */
        function handleToolbarClick(event) {
            const button = event.target.closest('button');
            if (!button) return;
            
            const action = button.getAttribute('data-action');
            if (!action) return;

            // æ ¹æ®ä¸åŒçš„actionæ‰§è¡Œä¸åŒçš„æ“ä½œ
            switch (action) {
                // Markdownæ ¼å¼æŒ‰é’®
                case 'bold':
                    // æ’å…¥ **ç²—ä½“**ï¼Œå…‰æ ‡å®šä½åœ¨ä¸¤ä¸ªæ˜Ÿå·ä¸­é—´
                    insertAtCursor(editor, '****', -2);
                    break;
                
                case 'italic':
                    // æ’å…¥ *æ–œä½“*ï¼Œå…‰æ ‡å®šä½åœ¨ä¸¤ä¸ªæ˜Ÿå·ä¸­é—´
                    insertAtCursor(editor, '**', -1);
                    break;
                
                case 'strikethrough':
                    // æ’å…¥ ~~åˆ é™¤çº¿~~ï¼Œå…‰æ ‡å®šä½åœ¨ä¸¤ä¸ªæ³¢æµªå·ä¸­é—´
                    insertAtCursor(editor, '~~~~', -2);
                    break;
                
                case 'h1':
                    // æ’å…¥ä¸€çº§æ ‡é¢˜ï¼Œå…‰æ ‡å®šä½åœ¨#åé¢
                    insertAtCursor(editor, '# ', 0);
                    break;
                
                case 'h2':
                    // æ’å…¥äºŒçº§æ ‡é¢˜ï¼Œå…‰æ ‡å®šä½åœ¨##åé¢
                    insertAtCursor(editor, '## ', 0);
                    break;
                
                case 'h3':
                    // æ’å…¥ä¸‰çº§æ ‡é¢˜ï¼Œå…‰æ ‡å®šä½åœ¨###åé¢
                    insertAtCursor(editor, '### ', 0);
                    break;
                
                case 'h4':
                    // æ’å…¥å››çº§æ ‡é¢˜ï¼Œå…‰æ ‡å®šä½åœ¨####åé¢
                    insertAtCursor(editor, '#### ', 0);
                    break;
                
                case 'h5':
                    // æ’å…¥äº”çº§æ ‡é¢˜ï¼Œå…‰æ ‡å®šä½åœ¨#####åé¢
                    insertAtCursor(editor, '##### ', 0);
                    break;
                
                case 'h6':
                    // æ’å…¥å…­çº§æ ‡é¢˜ï¼Œå…‰æ ‡å®šä½åœ¨######åé¢
                    insertAtCursor(editor, '###### ', 0);
                    break;
                
                case 'ulist':
                    // æ’å…¥æ— åºåˆ—è¡¨ï¼Œå…‰æ ‡å®šä½åœ¨-åé¢
                    insertAtCursor(editor, '- ', 0);
                    break;
                
                case 'olist':
                    // æ’å…¥æœ‰åºåˆ—è¡¨ï¼Œå…‰æ ‡å®šä½åœ¨1.åé¢
                    insertAtCursor(editor, '1. ', 0);
                    break;
                
                case 'tasklist':
                    // æ’å…¥ä»»åŠ¡åˆ—è¡¨é¡¹ï¼Œå…‰æ ‡å®šä½åœ¨[ ]ä¸­é—´
                    insertAtCursor(editor, '- [ ] ', -2);
                    break;
                
                case 'quote':
                    // æ’å…¥å¼•ç”¨ï¼Œå…‰æ ‡å®šä½åœ¨>åé¢
                    insertAtCursor(editor, '> ', 0);
                    break;
                
                case 'code':
                    // æ’å…¥ä»£ç å—ï¼Œå…‰æ ‡å®šä½åœ¨ä¸¤ä¸ªåå¼•å·ä¸­é—´
                    insertAtCursor(editor, '``', -1);
                    break;
                
                case 'link':
                    // æ’å…¥é“¾æ¥ï¼Œå…‰æ ‡å®šä½åœ¨é“¾æ¥æ–‡æœ¬ä½ç½®
                    insertAtCursor(editor, '[]()', -3);
                    break;
                
                case 'table':
                    // æ’å…¥è¡¨æ ¼æ¨¡æ¿ï¼Œå…‰æ ‡å®šä½åœ¨ç¬¬ä¸€ä¸ªå•å…ƒæ ¼å†…å®¹ä½ç½®
                    const tableTemplate = '| åˆ—1 | åˆ—2 | åˆ—3 |\n| --- | --- | --- |\n| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 |';
                    const cursorPos = '| '.length; // å…‰æ ‡å®šä½åœ¨"åˆ—1"çš„ä½ç½®
                    insertAtCursor(editor, tableTemplate, -(tableTemplate.length - cursorPos));
                    break;
                
                // æ–‡ä»¶æ“ä½œæŒ‰é’®
                case 'new':
                    newFile();
                    return; // ä¸éœ€è¦æ›´æ–°é¢„è§ˆï¼ŒnewFileå·²ç»å¤„ç†äº†
                
                case 'open':
                    openFile();
                    return; // ä¸éœ€è¦æ›´æ–°é¢„è§ˆ
                
                case 'save':
                    saveFile();
                    return; // ä¸éœ€è¦æ›´æ–°é¢„è§ˆ
                
                case 'autosave':
                    toggleAutosave();
                    return; // ä¸éœ€è¦æ›´æ–°é¢„è§ˆ
                
                case 'theme':
                    toggleTheme();
                    return; // ä¸éœ€è¦æ›´æ–°é¢„è§ˆ
            }

            // æ’å…¥åç«‹å³æ›´æ–°é¢„è§ˆï¼ˆä¸ä½¿ç”¨é˜²æŠ–ï¼Œç¡®ä¿å³æ—¶åé¦ˆï¼‰
            updatePreviewInternal();
        }

        /**
         * åˆ‡æ¢ä¸»é¢˜
         */
        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-theme');
            
            if (isDark) {
                body.classList.remove('dark-theme');
                themeBtn.textContent = 'ğŸŒ™';
                localStorage.setItem(STORAGE_KEY_THEME, 'light');
            } else {
                body.classList.add('dark-theme');
                themeBtn.textContent = 'â˜€ï¸';
                localStorage.setItem(STORAGE_KEY_THEME, 'dark');
            }
        }

        /**
         * åŠ è½½ä¸»é¢˜åå¥½
         */
        function loadTheme() {
            const savedTheme = localStorage.getItem(STORAGE_KEY_THEME);
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeBtn.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('dark-theme');
                themeBtn.textContent = 'ğŸŒ™';
            }
        }

        /**
         * æ‹–æ‹½è°ƒæ•´å®½åº¦åŠŸèƒ½
         */
        function initResizer() {
            // ç§»åŠ¨ç«¯ä¸å¯ç”¨æ‹–æ‹½åŠŸèƒ½
            if (window.innerWidth <= 768) {
                return;
            }

            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startWidth = mainContainer.offsetWidth;
                const currentEditorWidth = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--editor-width')) || 50;
                startWidth = (currentEditorWidth / 100) * startWidth;
                
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const diff = e.clientX - startX;
                const containerWidth = mainContainer.offsetWidth;
                const newWidth = startWidth + diff;
                const percentage = (newWidth / containerWidth) * 100;
                
                // é™åˆ¶å®½åº¦èŒƒå›´ï¼ˆ20% - 80%ï¼‰
                const clampedPercentage = Math.max(20, Math.min(80, percentage));
                
                document.documentElement.style.setProperty('--editor-width', clampedPercentage + '%');
                document.documentElement.style.setProperty('--preview-width', (100 - clampedPercentage) + '%');
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    // ä¿å­˜å®½åº¦åå¥½
                    const editorWidth = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--editor-width')) || 50;
                    localStorage.setItem(STORAGE_KEY_WIDTH, editorWidth.toString());
                }
            });
        }

        /**
         * åŠ è½½å®½åº¦åå¥½
         */
        function loadWidth() {
            const savedWidth = localStorage.getItem(STORAGE_KEY_WIDTH);
            if (savedWidth) {
                const width = parseFloat(savedWidth);
                document.documentElement.style.setProperty('--editor-width', width + '%');
                document.documentElement.style.setProperty('--preview-width', (100 - width) + '%');
            }
        }

        // ä¸ºæ‰€æœ‰å·¥å…·æ æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
        const toolbarButtons = document.querySelectorAll('.toolbar button');
        toolbarButtons.forEach(button => {
            button.addEventListener('click', handleToolbarClick);
        });

        // å®æ—¶åŒæ­¥åŠŸèƒ½ï¼šç›‘å¬textareaçš„è¾“å…¥äº‹ä»¶
        editor.addEventListener('input', function() {
            // ä½¿ç”¨parseMarkdownå‡½æ•°å¤„ç†Markdownæ–‡æœ¬å¹¶è½¬æ¢ä¸ºHTML
            updatePreview();
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        function init() {
            // åŠ è½½ä¸»é¢˜åå¥½
            loadTheme();
            
            // åŠ è½½å®½åº¦åå¥½
            loadWidth();
            
            // åˆå§‹åŒ–æ‹–æ‹½è°ƒæ•´å®½åº¦
            initResizer();
            
            // ä»localStorageæ¢å¤å†…å®¹
            loadFromLocalStorage();
            
            // åˆå§‹åŒ–è‡ªåŠ¨ä¿å­˜UI
            updateAutosaveUI();
            
            // å¯åŠ¨è‡ªåŠ¨ä¿å­˜ï¼ˆå¦‚æœå¼€å¯ï¼‰
            if (autosaveEnabled) {
                startAutosave();
            }
            
            // åˆå§‹åŒ–é¢„è§ˆï¼ˆç«‹å³æ‰§è¡Œï¼Œä¸ä½¿ç”¨é˜²æŠ–ï¼‰
            updatePreviewInternal();
        }

        // é¡µé¢å¸è½½æ—¶ä¿å­˜
        window.addEventListener('beforeunload', function() {
            if (autosaveEnabled) {
                saveToLocalStorage();
            }
        });

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>

